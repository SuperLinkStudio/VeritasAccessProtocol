# 核心操作规定

## scope 命名规范

### 基本结构

所有 scope 名称必须采用三级命名空间结构：

```
<service_name>:<scope>:<data_name>
```

但是，当需要的数据范围包含某一 scope_group 下的所有 scope_name 时，可使用以下简写形式:

```
<service_name>:<scope>
```

### 命名规则

| 组成部分       | 规则           |
| -------------- | -------------- |
| `service_name` | 资源服务器名称 |
| `scope`        | 数据范围分组   |
| `data_name`    | 单个数据名称   |

例如：

```
authorize:account_data:name
```

`service_name`、`scope_group` 和 `scope_name` 应当遵循下划线命名法，禁止包含空格，且不应包含大写字母，不推荐使用拼音。

## 网络请求规范

VAP 协议所涉及的所有网络请求 (重定向除外) 均**必须**使用 `POST` 请求，并严格遵守以下规定:

- 请求头 Content-Type 必须设置为 `application/json`
- 所有请求参数和返回数据必须通过 Body 传输
- 禁止在 URL 查询参数、Header 或 Cookie 中传递敏感数据
- Body 数据必须为严格符合 `RFC 8259` 标准的 `JSON` 格式

VAP 协议强制要求使用 `HTTPS`。

## 核心操作流程

### 客户端上线前

该流程应当由客户端的开发者完成，客户端的开发者应当在**认证服务器的官方网站中**或**线下**向认证服务器完成注册。

VAP 协议不涉及注册时具体流程，但是客户端应当向认证服务器提供以下信息:

| 名称                      | 解释                                                 |
| ------------------------- | ---------------------------------------------------- |
| `after_auth_redirect_url` | 用户身份认证结束后，认证服务器将把用户重定向到的地址 |

当注册结束时，认证服务器至少应当生成如下信息:

| 名称            | 应向客户端的开发者提供 | 解释                      |
| --------------- | ---------------------- | ------------------------- |
| `client_id`     | 必须                   | 客户端唯一标识符          |
| `tdt_secret`    | 必须                   | 客户端的 TDT 算法密钥     |
| `authorize_url` | 应当                   | 用户身份认证界面地址      |
| `redeem_url`    | 应当                   | 资源访问令牌兑换 API 地址 |
| `update_url`    | 应当                   | 资源访问令牌更新 API 地址 |
| `destroy_url`   | 应当                   | 资源访问令牌销毁 API 地址 |

客户端必须对认证服务器所提供的信息进行保密，并做好充足的防泄漏措施。

### 资源服务器上线前

该流程应当由资源服务器的开发者完成，资源服务器的开发者应当在**认证服务器的官方网站中**或**线下**向认证服务器完成注册。

VAP 协议不涉及注册时具体流程，但是资源服务器应当向认证服务器提供并且对外公开以下信息:

| 名称           | 解释                                                                                                                                                                                                          |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `service_name` | 资源服务器名称                                                                                                                                                                                                |
| `resource_url` | 用户数据访问 API 地址                                                                                                                                                                                         |
| `scope_names`  | (字符串数组) 资源服务器提供的数据范围名称列表，对于其中每一个元素 `scope_name`，都是格式为 `<scope>:<data_name>` 的字符串，表示资源服务器提供的数据范围名称，具体细则请参考 [scope 命名规范](#scope-命名规范) |

> [!TIP]
> 注意: `service_name` 和 `scope_name` 应当遵循下划线命名法，禁止包含空格，且不应包含大写字母，不推荐使用拼音。

当注册结束时，认证服务器至少应当生成如下信息:

| 名称                 | 应向资源服务器的开发者提供 | 解释                            |
| -------------------- | -------------------------- | ------------------------------- |
| `resource_server_id` | 必须                       | 资源服务器唯一标识符            |
| `tdt_secret`         | 必须                       | 资源服务器的 TDT 算法密钥       |
| `authentication_url` | 应当                       | 客户端资源访问令牌鉴权 API 地址 |

资源服务器必须对认证服务器所提供的信息进行保密，并做好充足的防泄漏措施。

### 客户端获取资源访问令牌

该流程应当在客户端尝试获取用户信息前完成。

1. **客户端**将**用户**重定向到**认证服务器**的 `authorize_url`，并附上以下内容作为查询:

   | 内容        | 解释                                             |
   | ----------- | ------------------------------------------------ |
   | `client_id` | 客户端唯一标识符                                 |
   | `scope`     | 客户端将要被授权访问的数据范围，多个，由空格隔开 |

2. **用户**在**认证服务器**处完成用户身份认证，向**用户**展示**客户端**的 `scope` 并询问是否授权

   VAP 协议不涉及用户身份认证其余具体细节。

   建议认证服务器允许用户自行缩小 `scope` 范围。

3. **认证服务器**将**用户**重定向到**客户端**的 `after_auth_redirect_url`，并附上以下内容作为查询:

   | 内容   | 解释                                                              |
   | ------ | ----------------------------------------------------------------- |
   | `code` | (由**认证服务器**加密并签名，以字符串形式传输) 资源访问令牌兑换码 |

4. **客户端**向**认证服务器**的 `redeem_url` 发送 `POST` 请求，并附上以下内容作为 Body 部分:

   | 内容        | 解释                                        |
   | ----------- | ------------------------------------------- |
   | `client_id` | 客户端唯一标识符                            |
   | `code`      | (由**客户端**加密并签名) 资源访问令牌兑换码 |
   | `tdt`       | (由**客户端**加密并签名) TDT 值             |

5. **认证服务器**生成 `access_token` 并**销毁 `code`**

   要求：

   - `access_token` 必须是**独一无二**的
   - 将 `access_token` 与 `client_id` 相关联并持久化存储其关系

6. **认证服务器**对于来自**客户端**的请求返回如下内容:

   | 内容           | 解释                                      |
   | -------------- | ----------------------------------------- |
   | `access_token` | (由**认证服务器**加密并签名) 资源访问令牌 |
   | `expire_time`  | 到期时间，为 `yyyy-MM-dd HH-mm-ss` 格式   |

### 客户端获取用户数据

该流程应当在客户端获取资源访问令牌之后、资源访问令牌被销毁之前完成。

1. **客户端**向**资源服务器**的 `resource_url` 发送 `POST` 请求，并附上以下内容作为 Body 部分:

   | 内容           | 解释                                                                                                                    |
   | -------------- | ----------------------------------------------------------------------------------------------------------------------- |
   | `client_id`    | 客户端唯一标识符                                                                                                        |
   | `access_token` | (**客户端**与**认证服务器**之间，由**客户端**加密并签名) 资源访问令牌                                                   |
   | `scope`        | (**客户端**与**认证服务器**之间，由**客户端**加密并签名) 客户端将要尝试访问的数据范围，(对于原文而言)，多个，由空格隔开 |
   | `tdt`          | (**客户端**与**认证服务器**之间，由**客户端**加密并签名) TDT 值                                                         |

2. **资源服务器**向**认证服务器**的 `authentication_url` 发送 `POST` 请求，并附上以下内容作为 Body 部分:

   | 内容                  | 解释                                                                    |
   | --------------------- | ----------------------------------------------------------------------- |
   | `resource_server_id`  | 资源服务器唯一标识符                                                    |
   | `scope`               | 客户端 `scope`，原样发送                                                |
   | `client_id`           | 客户端 `client_id`，原样发送                                            |
   | `client_access_token` | 客户端 `access_token`，原样发送                                         |
   | `client_tdt`          | 客户端 `tdt`，原样发送                                                  |
   | `tdt`                 | (**资源服务器**与**认证服务器**之间，由**资源服务器**加密并签名) TDT 值 |

3. **认证服务器** 验证并确定以下内容有效:

   - `scope`
   - `client_id`
   - `client_access_token`
   - `client_tdt`
   - `tdt`

4. **认证服务器**对于来自**资源服务器**的请求返回如下内容:

   | 内容                   | 解释                                                                                                            |
   | ---------------------- | --------------------------------------------------------------------------------------------------------------- |
   | `scope`                | (**认证服务器**与**资源服务器**之间，由**认证服务器**加密并签名) 认证服务器允许客户端访问的数据范围             |
   | `scope_to_client`      | (**认证服务器**与**客户端**之间，由**认证服务器**加密并签名) 认证服务器允许客户端访问的数据范围                 |
   | `account_id`           | (**认证服务器**与**资源服务器**之间，由**认证服务器**加密并签名) 客户端 `access_token` 所绑定的用户的唯一标识符 |
   | `account_id_to_client` | (**认证服务器**与**客户端**之间，由**认证服务器**加密并签名) 客户端 `access_token` 所绑定的用户的唯一标识符     |

5. **资源服务器**对于来自**客户端**的请求返回如下内容:

   | 内容         | 解释                                        |
   | ------------ | ------------------------------------------- |
   | `scope`      | 认证服务器 `scope_to_client`，原样发送      |
   | `account_id` | 认证服务器 `account_id_to_client`，原样发送 |
   | `user_data`  | (由**资源服务器**加密并签名) 用户数据       |

   `user_data` 原文应当是一个符合 `RFC 8259` 标准的 `JSON` 文本，以每个 `scope` 为 Key， 以每个 `scope` 所对应的用户数据为 Value。对于非户数据的 `scope`，其对应 Value 应当为 null，即空值。

   `user_data` 原文示例:

   ```JSON
   {
    "authorize:account_data:name": "A White Cat",
    "authorize:account_data:bio": "I'am a white cat",
    "service:file:delete": null
   }
   ```

### 客户端更新资源访问令牌

该流程应当在客户端获取资源访问令牌之后、资源访问令牌将要或已经到期之时、资源访问令牌被销毁之前完成。

1. **客户端**向**认证服务器**的 `update_url` 发送 `POST` 请求，并附上以下内容作为 Body 部分:

   | 内容           | 解释                                      |
   | -------------- | ----------------------------------------- |
   | `client_id`    | 客户端唯一标识符                          |
   | `access_token` | (由**客户端**加密并签名) 旧的资源访问令牌 |
   | `tdt`          | (由**客户端**加密并签名) TDT 值           |

2. **认证服务器**对于来自**客户端**的请求返回如下内容:

   | 内容           | 解释                                          |
   | -------------- | --------------------------------------------- |
   | `access_token` | (由**认证服务器**加密并签名) 新的资源访问令牌 |
   | `expire_time`  | 到期时间，为 `yyyy-MM-dd HH-mm-ss` 格式       |

获取到新的资源访问令牌后，旧的资源访问令牌将保留一段时间 (具体时长由**认证服务器**规定，此时旧令牌被标记为弃用，不会因为新令牌刷新而被复写)，留出处理异常的余地，出现异常后客户端应当立刻以手中现有令牌更新资源访问令牌。

### 客户端销毁资源访问令牌

该流程应当在客户端主动毁资源访问令牌之时完成。

1. **客户端**向**认证服务器**的 `delete_url` 发送 `POST` 请求，并附上以下内容作为 Body 部分:

   | 内容           | 解释                                  |
   | -------------- | ------------------------------------- |
   | `client_id`    | 客户端唯一标识符                      |
   | `access_token` | (由**客户端**加密并签名) 资源访问令牌 |
   | `tdt`          | (由**客户端**加密并签名) TDT 值       |

2. **认证服务器**销毁**客户端**计划销毁的资源访问令牌

3. **认证服务器**对于来自**客户端**的请求返回如下内容:

   ```http
   200 OK
   ```

## 错误处理与错误码

对于任何请求**认证服务器**或**资源服务器**服务的一方 (以下简称: 请求方) 信息验证不通过、密钥错误、请求格式错误等问题和异常，**认证服务器**或**资源服务器**统一回复以下格式的信息:

```json
{
  "error": "<error_code>"
}
```

其中，`error_code` 为错误码。

### 标准错误码表

| 错误码                | 解释                                 |
| --------------------- | ------------------------------------ |
| `unknow_id`           | 请求方提供的统一标识符不存在         |
| `tdt_error`           | 请求方提供的 `tdt` 异常              |
| `encrypt_error`       | 密文或签名等与加密相关的信息的异常   |
| `unknow_code`         | 请求方提供的资源访问令牌兑换码不存在 |
| `unknow_client_id`    | 请求方提供的资源访问令牌不存在       |
| `outdated_client_id`  | 请求方提供的资源访问令牌已过期       |
| `old_client_id`       | 请求方提供的资源访问令牌弃用         |
| `outdated_secret_key` | 请求方的密钥已过期                   |
| `security_exception`  | 安全性出现异常                       |
| `refuse_service`      | 出现了未知异常，拒绝提供服务         |
